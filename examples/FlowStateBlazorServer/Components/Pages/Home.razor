@page "/"
@using FlowState.Components
@using FlowState.Models
@using System.Threading.Tasks
@using FlowState.Models.Events
@rendermode InteractiveServer	

<PageTitle>Home</PageTitle>


<button @onclick="SaveGraph">Save Graph</button>
<button @onclick="ClearGraph">Clear Graph</button>
<button @onclick="LoadGraph">Load Graph</button>
<button @onclick="RemoveNode">Remove Node</button>

<FlowCanvas Height="100vh" Width="100vw" Graph="graph" OnCanvasLoaded="OnLoaded" OnSelectionChanged="NodesSelected">
 <BackgroundContent>
        <FlowBackground class="flow-grid-lines"/>
    </BackgroundContent>
    </FlowCanvas>



@code
{
    FlowGraph graph = new FlowGraph();
    private string data="{}";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        graph.RegisterNode<InputNode>();
    }
    private NodeInfo? fromNodeInfo,toNodeInfo;
    private EdgeInfo? edgeInfo;

    private async Task OnLoaded()
    {

        graph.TypeCompatibiltyRegistry.Register<float>(typeof(int));
        //FlowNodeBase c= graph.Nodes.First();
        //Console.WriteLine($"Node count: {c.X},{c.Y}");
        fromNodeInfo=graph.CreateNode<InputNode>(0,0,[]);
        toNodeInfo = graph.CreateNode<InputNode>(200,200,[]);

        await Task.Delay(100);

        //edgeInfo = graph.Connect(fromNodeInfo.Id,toNodeInfo.Id,"Output","Input").Edge;
        //Console.WriteLine(data.Error);
    }


    private async Task SaveGraph()
    {
        data = await graph.SerializeAsync();
    }

    private async Task ClearGraph()
    {
        await graph.ClearAsync();
    }

    private async Task LoadGraph()
    {
        await graph.DeserializeAsync(data);
    }

    private string[] selection=[];
    private void NodesSelected(string[] selectedNodes)
    {
        selection = selectedNodes;
    }
    private async Task RemoveNode()
    {
        graph.RemoveNode(selection.First());
    }
    private void RemoveEdge()
    {
        graph.RemoveEdge(edgeInfo.Id);
    }
}

<style>
.flow-grid-lines
{
    background: #111827;
    background-image: 
    /* Main grid lines */
    linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px),
    /* Minor grid lines */
    linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size: 
    100px 100px,
    100px 100px,
    20px 20px,
    20px 20px;
  background-position: 
    0 0,        /* Main grid */
    0 0,        /* Main grid */
    0 0,        /* Minor grid */
    0 0;        /* Minor grid */
}

/* Input box styles */
.input-box {
  width: 90%;
  padding: 6px 8px;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  background: rgba(255,255,255,0.05);
  color: #fff;
  font-size: 12px;
  outline: none;
  transition: all 0.2s ease;
  margin: 4px 0;
  pointer-events: auto;
  cursor: text;
}

.input-box:focus {
  border-color: var(--fg-accent);
  background: rgba(255,255,255,0.1);
}

.input-box::placeholder {
  color: rgba(255,255,255,0.5);
}

</style>